<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SafeRoads - מפת תאונות דרכים">
    <meta name="theme-color" content="#2563eb">
    <title>SafeRoads - מפת ישראל</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Add Leaflet.heat -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <!-- Add Leaflet.markercluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            height: 80vh;
            width: 100%;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .map-container {
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 1rem 0;
        }
        .map-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1rem;
            align-items: start;
        }
        .map-sidebar {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .map-controls {
            margin-bottom: 1rem;
        }
        .map-button {
            width: 100%;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface-color);
            border: 1px solid var(--primary-color);
            color: #000000 !important;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }
        .map-button:hover {
            background: var(--primary-color);
            color: #000000 !important;
        }
        .legend {
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
        }
        .legend h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 1.1rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.95rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .container {
            max-width: 1600px;
            width: 95%;
        }
        .actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-start;
            gap: 1rem;
        }
        .filters {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
        }
        .filter-group {
            margin-bottom: 1rem;
        }
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        .stats {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--background-color);
            border-radius: var(--border-radius);
        }
        .stats h3 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .map-layout {
                grid-template-columns: 1fr;
            }
            #map {
                height: 60vh;
            }
        }
        .heatmap-legend {
            background: linear-gradient(to left, #00ff00, #ffff00, #ff0000);
            height: 20px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .heatmap-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="text-align: center; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <img src="/static/ChatGPT Image Aug 2, 2025 at 06_37_23 PM.png" alt="SafeRoads Logo" style="width: 130px; height: auto;">
            </div>
            <h1>מפת תאונות דרכים</h1>
            <p class="subtitle">מפה אינטראקטיבית המציגה את פיזור התאונות ברחבי הארץ</p>
        </header>

        <main>
            <div class="map-layout">
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="map-sidebar">
                    <div class="filters">
                        <h3>סינון תאונות</h3>
                        <div class="filter-group">
                            <label for="yearFilter">שנה</label>
                            <select id="yearFilter">
                                <option value="">כל השנים</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="severityFilter">חומרת תאונה</label>
                            <select id="severityFilter">
                                <option value="">הכל</option>
                                <option value="fatal">קטלנית</option>
                                <option value="severe">קשה</option>
                                <option value="light">קלה</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="timeFilter">זמן ביממה</label>
                            <select id="timeFilter">
                                <option value="">הכל</option>
                                <option value="day">יום</option>
                                <option value="night">לילה</option>
                            </select>
                        </div>
                    </div>

                    <div class="map-controls">
                        <button class="map-button" onclick="zoomToIsrael()">מרכז למפת ישראל</button>
                        <button class="map-button" onclick="toggleHeatmap()">הצג/הסתר מפת חום</button>
                        <button class="map-button" onclick="toggleMarkers()">הצג/הסתר נקודות</button>
                        
                        <div class="legend">
                            <h3>צפיפות תאונות</h3>
                            <div class="heatmap-legend"></div>
                            <div class="heatmap-labels">
                                <span>נמוך</span>
                                <span>בינוני</span>
                                <span>גבוה</span>
                            </div>
                            <div class="legend-item" style="margin-top: 20px;">
                                <div class="legend-color" style="background: #ef4444"></div>
                                <span>תאונה קטלנית</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f59e0b"></div>
                                <span>תאונה קשה</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #10b981"></div>
                                <span>תאונה קלה</span>
                            </div>
                        </div>
                    </div>

                    <div class="stats">
                        <h3>סטטיסטיקה</h3>
                        <div class="stats-item">
                            <span>סה"כ תאונות:</span>
                            <span id="totalAccidents">0</span>
                        </div>
                        <div class="stats-item">
                            <span>תאונות קטלניות:</span>
                            <span id="fatalAccidents">0</span>
                        </div>
                        <div class="stats-item">
                            <span>תאונות קשות:</span>
                            <span id="severeAccidents">0</span>
                        </div>
                        <div class="stats-item">
                            <span>תאונות קלות:</span>
                            <span id="lightAccidents">0</span>
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 2rem; display: flex; gap: 1rem;">
                        <a href="/" class="back-button">
                            <span class="button-icon">←</span>
                            <span class="button-text">חזרה לדף הבית</span>
                        </a>
                        {% if prediction %}
                        <a href="/result" class="back-button">
                            <span class="button-icon">←</span>
                            <span class="button-text">חזרה לתוצאות החיזוי</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Initialize map centered on Israel
        const map = L.map('map').setView([31.7683, 35.2137], 8);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Initialize layers
        let markersLayer = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        let heatLayer = null;
        let accidents = [];
        let filteredAccidents = [];

        // Function to zoom to Israel
        function zoomToIsrael() {
            map.setView([31.7683, 35.2137], 8);
        }

        // Function to toggle heatmap
        function toggleHeatmap() {
            if (map.hasLayer(heatLayer)) {
                map.removeLayer(heatLayer);
            } else {
                updateHeatmap();
                map.addLayer(heatLayer);
            }
        }

        // Function to toggle markers
        function toggleMarkers() {
            if (map.hasLayer(markersLayer)) {
                map.removeLayer(markersLayer);
            } else {
                map.addLayer(markersLayer);
            }
        }

        // Function to update statistics
        function updateStats(data) {
            const stats = {
                total: data.length,
                light: data.filter(a => a.humrat_teuna === 3).length,
                severe: data.filter(a => a.humrat_teuna === 2).length,
                fatal: data.filter(a => a.humrat_teuna === 1).length
            };

            document.getElementById('totalAccidents').textContent = stats.total.toLocaleString();
            document.getElementById('lightAccidents').textContent = stats.light.toLocaleString();
            document.getElementById('severeAccidents').textContent = stats.severe.toLocaleString();
            document.getElementById('fatalAccidents').textContent = stats.fatal.toLocaleString();
        }

        // Function to update heatmap
        function updateHeatmap() {
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }

            const heatData = filteredAccidents.map(point => [
                point.latitude,
                point.longitude,
                1  // ערך קבוע לכל נקודה כדי למדוד רק צפיפות
            ]);

            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                max: Math.max(10, Math.ceil(heatData.length / 100)),  // התאמה דינמית של הסקאלה
                gradient: {
                    0.2: '#00ff00',  // ירוק - מעט תאונות
                    0.5: '#ffff00',  // צהוב - בינוני
                    0.8: '#ff0000'   // אדום - הרבה תאונות
                }
            });

            if (map.hasLayer(heatLayer)) {
                map.addLayer(heatLayer);
            }
        }

        // Function to update markers
        function updateMarkers() {
            markersLayer.clearLayers();

            filteredAccidents.forEach(point => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="
                        background-color: ${
                            point.humrat_teuna === 1 ? '#ef4444' :
                            point.humrat_teuna === 2 ? '#f59e0b' :
                            '#10b981'
                        };
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        opacity: 0.8;
                    "></div>`,
                    iconSize: [8, 8]
                });

                L.marker([point.latitude, point.longitude], { icon })
                    .bindPopup(`
                        <div style="text-align: right; direction: rtl;">
                            <strong>פרטי התאונה:</strong><br>
                            סוג: ${
                                point.humrat_teuna === 1 ? 'קטלנית' :
                                point.humrat_teuna === 2 ? 'קשה' : 'קלה'
                            }<br>
                            שנה: ${point.shnat_teuna || 'לא ידוע'}<br>
                            חודש: ${point.hodesh_teuna || 'לא ידוע'}<br>
                            ${point.street ? `רחוב: ${point.street}` : ''}
                        </div>
                    `)
                    .addTo(markersLayer);
            });
        }

        // Function to apply filters
        function applyFilters() {
            const year = document.getElementById('yearFilter').value;
            const severity = document.getElementById('severityFilter').value;
            const time = document.getElementById('timeFilter').value;

            filteredAccidents = accidents.filter(accident => {
                // Check year filter - use shnat_teuna if date doesn't exist
                if (year) {
                    const accidentYear = accident.date ? accident.date.split('-')[0] : accident.shnat_teuna;
                    if (accidentYear != year) return false;
                }
                
                // Check severity filter
                if (severity) {
                    const accidentSeverity = accident.humrat_teuna === 1 ? 'fatal' : 
                                           accident.humrat_teuna === 2 ? 'severe' : 'light';
                    if (accidentSeverity !== severity) return false;
                }
                
                // Check time filter
                if (time) {
                    const isDay = accident.yom_layla === 1;
                    if (time === 'day' && !isDay) return false;
                    if (time === 'night' && isDay) return false;
                }
                return true;
            });

            updateMarkers();
            updateHeatmap();
            updateStats(filteredAccidents);
        }

        // Add event listeners to filters
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
        document.getElementById('severityFilter').addEventListener('change', applyFilters);
        document.getElementById('timeFilter').addEventListener('change', applyFilters);

        // Fetch accident data from server
        fetch('/api/accidents')
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'שגיאה בטעינת נתונים');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                accidents = data;
                filteredAccidents = data;

                // Update year filter options - use shnat_teuna if date doesn't exist
                const years = [...new Set(data.map(a => a.date ? a.date.split('-')[0] : a.shnat_teuna))].sort();
                const yearFilter = document.getElementById('yearFilter');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });

                // Initialize visualization
                updateStats(data);
                updateMarkers();
                map.addLayer(markersLayer);
                
                updateHeatmap();
                map.addLayer(heatLayer);
            })
            .catch(error => {
                console.error('Error loading accident data:', error);
                alert(error.message || 'שגיאה בטעינת נתוני התאונות');
            });
    </script>
</body>
</html> 